tosca_definitions_version: tosca_simple_yaml_1_3

metadata:

  template_name: Simple Cluster
  template_author: Crucible

description: >-
  This example installs a single cluster with 3 master nodes provisioned as VMs and 2 working nodes
  that are baremetal. It additionally uses two nodes:

  * Bastion: where Crucible runs and finally stores results.
  * Services: runs all our required services (DNS, NTP, Registry, Assisted Installer) and VMs.

imports:

- file: crucible.yaml
  namespace_prefix: crucible

topology_template:

  node_templates:

    # Our cluster

    cluster:
      type: crucible:Cluster
      properties:
        name: clustername
        version: 4.6.16
      requirements:
      - bastion: { capability: crucible:Bastion }
      # Services
      - dns: { capability: crucible:DNS }
      - ntp: service # alternative we can specify "ntp" node template
      - store: { capability: crucible:Store }
      - registry: { capability: crucible:Registry }
      - ai: { capability: crucible:AssistedInstaller }
      # Machines
      - machine:
          node: master1
          relationship:
            properties:
              role: master
      - machine:
          node: master2
          relationship:
            properties:
              role: master
      - machine:
          node: master3
          relationship:
            properties:
              role: master
      - machine:
          node: worker1
          relationship:
            properties:
              role: worker
              installation-disk: /dev/sdb
      - machine:
          node: worker2
          relationship:
            properties:
              role: worker
              installation-disk: /dev/sdb
      artifacts:
        public-key:
          type: crucible:Key
          file: artifacts/public.key

    master1:
      type: crucible:VM
      properties:
        mac: DE:AD:BE:EF:C0:2C
        ip: 10.60.0.101
        cpu-cores: 4
        ram: 6144 mib
        disk: 20 gb

    master2:
      type: crucible:VM
      properties:
        mac: DE:AD:BE:EF:C0:2D
        ip: 10.60.0.102
        cpu-cores: 4
        ram: 6144 mib
        disk: 20 gb

    master3:
      type: crucible:VM
      properties:
        mac: DE:AD:BE:EF:C0:2E
        ip: 10.60.0.103
        cpu-cores: 4
        ram: 6144 mib
        disk: 20 gb

    worker1:
      type: crucible:Baremetal
      properties:
        mac: 3C:FD:FE:78:AB:03
        ip: 10.60.0.104
        vendor: Dell
      capabilities:
        bmc:
          properties:
            ip: 172.28.11.25

    worker2:
      type: crucible:Baremetal
      properties:
        mac: 3C:FD:FE:78:AB:04
        ip: 10.60.0.105
        vendor: Dell
      capabilities:
        bmc:
          properties:
            ip: 172.28.11.26

    # Crucible services

    bastion:
      type: crucible:Bastion
      properties:
        ip: 172.28.11.51

    service:
      description: >-
        All required services as well as the master node VMs are here
      type: crucible:ServiceMachine
      properties:
        ip: 10.40.0.100
      capabilities:
        ntp: # ChronyNTP
          properties:
            allow: 10.40.0.0/24
        hypervisor: # KVM
          properties:
            virtual-bmc-port: 8082
            bridge-ip: 10.60.0.190
            bridge-interface: ens7f1
      requirements:
      - kvm-dns: service

    ntp:
      description: >-
        Preexisting NTP server in lab
      type: crucible:NTP
      properties:
        ip: ntp.example.lab

  groups:

    all-nodes:
      type: crucible:Nodes
      members:
      - master1
      - master2
      - master3
      - worker1
      - worker2

  policies:

  - bmc:
      type: crucible:Redfish
      properties:
        user: { get_input: bmc-user }
        password: { get_input: bmc-password }
      targets:
      - all-nodes

  inputs:

    bmc-user:
      type: string
      value: user

    bmc-password:
      type: string
      value: password
